<!DOCTYPE html>
{% load static %}

<html>
  <head>
    <meta charset="utf-8">
    <title>Pin Store</title>
  </head>

  <body>
    <img src="{% static 'main/hotdog.png' %}">
    <p>Wear your favorite hotdog emoticon with this limited-edition avant garde pin.</p>
    <form id="payment-form">
      <p><b>Secure Checkout</b></p>
        <div id="card-element" style="width: 300px; padding: 20px; border: 1px solid black"></div>

      <button id="submit" style="margin: 10px 0">Pay</button>
        <div id="card-errors" role="alert"></div>

    </form>

    <div id="success" style="display: none">âœ“ Success!</div>

    <script src="https://js.stripe.com/v3/"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script>
    var stripe = Stripe('pk_test_g7RaBWquzF2wx5MOpzvynTFO');

      var elements = stripe.elements();
      var style = {
        base: {
          color: "#32325d",
        }
      };

      var card = elements.create("card", { style: style });
      card.mount("#card-element");

      card.on('change', ({error}) => {
        const displayError = document.getElementById('card-errors');
        if (error) {
          displayError.textContent = error.message;
        } else {
          displayError.textContent = '';
        }
      });

      var form = document.getElementById('payment-form');

      form.addEventListener('submit', function(ev) {
        ev.preventDefault();
        stripe.confirmCardPayment("{{ client_secret }}", {
          payment_method: {
            card: card,
            billing_details: {
              name: 'Jenny Rosen'
            }
          }
        }).then(function(result) {
          if (result.error) {
            // Show error to your customer (e.g., insufficient funds)
            console.log(result.error.message);
            document.getElementById('card-errors').innerHTML = "! " + result.error.message;
          } else {
            // The payment has been processed!
            if (result.paymentIntent.status === 'succeeded') {
              document.getElementById('success').style.display="block";
              $.ajax({
                url: '{% url 'confirm_order' %}',
                data: {"result_id": result.paymentIntent.id},
                dataType: 'json',
                success: function() {console.log("Success")}
               });
            }
          }
        });
      });
    </script>
  </body>

</html>
